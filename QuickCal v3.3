<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Coagulomètre Mindray Interpolation</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: 'Arial', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    background: #1e1e2f;
    color: #fff;
    padding-top: 30px;
}
h2 { margin-bottom: 20px; }
.input-container { display: flex; flex-direction: column; align-items: center; }
input#inr_patient {
    width: 250px; height: 100px; font-size: 3rem;
    text-align: center; margin-bottom: 15px;
    border-radius: 20px; border: 2px solid #3498db;
    outline: none; background: #2c2c3e; color: #fff;
}
input#inr_patient:focus { border-color: #00bfff; box-shadow: 0 0 20px rgba(0,191,255,0.6); }
button {
    width: 150px; height: 70px; font-size: 1.7rem;
    border-radius: 20px; border: none; background-color: #3498db;
    color: white; cursor: pointer; margin-bottom: 20px;
}
button:hover { background-color: #00bfff; }
.results { margin-top: 20px; text-align: center; }
.result-value {
    font-size: 3rem; font-weight: bold;
    padding: 20px 35px; border-radius: 25px;
    display: inline-block; margin: 10px 0;
}
.normes { margin-top: 10px; font-size: 1.4rem; color: #ccc; font-weight: bold; }
canvas#courbe { margin-top: 30px; max-width: 90%; background: #2c2c3e; border-radius: 15px; padding: 15px; }
</style>
</head>

<body>
<h2>Coagulomètre – Mindray Interpolation</h2>

<div class="input-container">
    <input type="number" id="inr_patient" value="2.8" step="0.001" placeholder="INR patient">
    <button onclick="calculer()">OK</button>
    <div class="normes">Normes : INR 2–4, TP 70–100%</div>
</div>

<div class="results">
    <div>TQ (s) : <span id="tq_patient" class="result-value">--</span></div>
    <div>TP (%) : <span id="tp_patient" class="result-value">--</span></div>
</div>

<canvas id="courbe" width="700" height="450"></canvas>

<script>
// Table des 37 points
const temoins = [
{tq:13.0,tp:100.0},{tq:13.7,tp:89.7},{tq:14.3,tp:81.4},{tq:15.0,tp:74.5},
{tq:15.6,tp:68.6},{tq:16.3,tp:63.6},{tq:16.9,tp:59.3},{tq:17.6,tp:55.5},
{tq:18.2,tp:52.2},{tq:18.9,tp:49.3},{tq:19.5,tp:46.7},{tq:20.2,tp:44.3},
{tq:20.8,tp:42.2},{tq:21.5,tp:40.2},{tq:22.1,tp:38.4},{tq:22.8,tp:36.8},
{tq:23.4,tp:35.3},{tq:24.1,tp:34.0},{tq:24.7,tp:32.7},{tq:25.4,tp:31.5},
{tq:26.0,tp:30.4},{tq:26.7,tp:29.4},{tq:27.3,tp:28.4},{tq:28.0,tp:27.5},
{tq:28.6,tp:26.7},{tq:29.3,tp:25.9},{tq:29.9,tp:25.2},{tq:30.6,tp:24.5},
{tq:31.2,tp:23.8},{tq:31.9,tp:23.2},{tq:32.5,tp:22.6},{tq:33.2,tp:22.0},
{tq:33.8,tp:21.5},{tq:34.5,tp:20.9},{tq:35.1,tp:20.5},{tq:35.8,tp:20.0},
{tq:45.5,tp:14.9}
];

// Interpolation linéaire entre points
function interpTQ(INRp){
    // On suppose INR minimal = 1, maximal = 6.1 pour tous les points
    const minINR = 1.0, maxINR = 6.1;
    const n = temoins.length;
    const pos = (INRp - minINR)/(maxINR - minINR)*(n-1);
    const i = Math.floor(pos);
    const frac = pos - i;
    if(i >= n-1) return temoins[n-1].tq;
    if(i<0) return temoins[0].tq;
    return temoins[i].tq + frac*(temoins[i+1].tq - temoins[i].tq);
}

// Calcul TP via formule Mindray
function calcTP(TQp){
    const TQmin = temoins[0].tq;
    const TQmax = temoins[temoins.length-1].tq;
    return 100*(TQmax - TQp)/(TQmax - TQmin);
}

let chart;

function calculer(){
    const INRp = parseFloat(document.getElementById("inr_patient").value);
    if(!INRp || INRp<=0){alert("INR invalide"); return;}
    
    const TQp = interpTQ(INRp);
    const TPp = calcTP(TQp);
    
    const tqElem = document.getElementById("tq_patient");
    const tpElem = document.getElementById("tp_patient");
    tqElem.innerText = TQp.toFixed(1) + " s";
    tpElem.innerText = TPp.toFixed(2) + " %";
    
    tqElem.style.backgroundColor = (TQp>=13 && TQp<=45)?'#2ecc71':'#e74c3c';
    tpElem.style.backgroundColor = (TPp>=70 && TPp<=100)?'#2ecc71':'#e74c3c';

    // Courbe
    const points = temoins.map(t=>({x:t.tq,y:t.tp}));
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("courbe"),{
        type:'line',
        data:{datasets:[{label:'Courbe TP (%) vs TQ (s)',data:points,borderColor:'#00bfff',fill:false,tension:0.2}]},
        options:{scales:{x:{title:{display:true,text:'TQ (s)'}},y:{title:{display:true,text:'TP (%)'}}}}
    });
}

// Enter déclenche OK
document.getElementById("inr_patient").addEventListener("keypress",function(e){
    if(e.key==="Enter") calculer();
});

// Calcul initial
calculer();
</script>
</body>
</html>
